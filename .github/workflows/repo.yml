name: Publish to Repository

on:
  workflow_run:
    workflows: ["Release"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      tag:
        description: 'Version tag to publish (e.g., v0.2.0)'
        required: true

env:
  REPO_PATH: /home/xtom/repo.xtom.com
  GPG_KEY_ID: 6A2AA6C90062DF0B68A457347A34888888888888

jobs:
  publish:
    name: Publish Packages
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Get version and workflow run ID
        id: version
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.tag }}"
            # Find the Release workflow run for this tag
            RUN_ID=$(gh run list --workflow=release.yml --branch="${VERSION}" --status=success --limit=1 --json databaseId -q '.[0].databaseId')
            if [ -z "$RUN_ID" ]; then
              echo "Error: No successful Release workflow found for tag ${VERSION}"
              exit 1
            fi
          else
            VERSION="${{ github.event.workflow_run.head_branch }}"
            RUN_ID="${{ github.event.workflow_run.id }}"
          fi
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "Publishing version: $VERSION (workflow run: $RUN_ID)"

      - name: Download deb artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: deb-*
          path: artifacts/deb
          merge-multiple: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.version.outputs.run_id }}

      - name: Download rpm artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: rpm-*
          path: artifacts/rpm
          merge-multiple: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.version.outputs.run_id }}

      - name: List downloaded artifacts
        run: |
          echo "=== DEB packages ==="
          ls -la artifacts/deb/ || echo "No deb packages found"
          echo "=== RPM packages ==="
          ls -la artifacts/rpm/ || echo "No rpm packages found"

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev apt-utils createrepo-c rpm

      - name: Import GPG key
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          # Trust the key
          echo "${{ env.GPG_KEY_ID }}:6:" | gpg --import-ownertrust

      - name: Export GPG public key
        run: |
          mkdir -p repo
          gpg --armor --export ${{ env.GPG_KEY_ID }} > repo/xtom.key

      - name: Build DEB repository
        run: |
          VERSION=${{ steps.version.outputs.version }}

          # Create directory structure
          mkdir -p repo/deb/pool/main/r/rdap
          mkdir -p repo/deb/dists/stable/main/binary-amd64
          mkdir -p repo/deb/dists/stable/main/binary-arm64

          # Copy deb packages to pool
          cp artifacts/deb/*_amd64.deb repo/deb/pool/main/r/rdap/ || true
          cp artifacts/deb/*_arm64.deb repo/deb/pool/main/r/rdap/ || true

          # Generate Packages files
          cd repo/deb

          # amd64
          dpkg-scanpackages --arch amd64 pool/ > dists/stable/main/binary-amd64/Packages
          gzip -k dists/stable/main/binary-amd64/Packages

          # arm64
          dpkg-scanpackages --arch arm64 pool/ > dists/stable/main/binary-arm64/Packages
          gzip -k dists/stable/main/binary-arm64/Packages

          # Generate Release file
          cd dists/stable
          apt-ftparchive release . > Release

          # Sign Release file
          gpg --batch --yes --armor --detach-sign --output Release.gpg Release
          gpg --batch --yes --clearsign --output InRelease Release

          cd ../../../..
          echo "=== DEB repo structure ==="
          find repo/deb -type f | head -20

      - name: Build RPM repository
        run: |
          VERSION=${{ steps.version.outputs.version }}

          # Configure RPM signing
          cat > ~/.rpmmacros << EOF
          %_signature gpg
          %_gpg_name ${{ env.GPG_KEY_ID }}
          %__gpg /usr/bin/gpg
          EOF

          # Process each EL version
          for EL_VERSION in el8 el9 el10; do
            echo "Building repo for $EL_VERSION..."

            # Create directory structure
            mkdir -p repo/rpm/$EL_VERSION/x86_64/Packages
            mkdir -p repo/rpm/$EL_VERSION/aarch64/Packages

            # Copy and sign RPM packages
            if [ -f "artifacts/rpm/"*".x86_64.rpm" ]; then
              cp artifacts/rpm/*x86_64.rpm repo/rpm/$EL_VERSION/x86_64/Packages/
              rpm --addsign repo/rpm/$EL_VERSION/x86_64/Packages/*.rpm || echo "RPM signing skipped"
            fi

            if [ -f "artifacts/rpm/"*".aarch64.rpm" ]; then
              cp artifacts/rpm/*aarch64.rpm repo/rpm/$EL_VERSION/aarch64/Packages/
              rpm --addsign repo/rpm/$EL_VERSION/aarch64/Packages/*.rpm || echo "RPM signing skipped"
            fi

            # Create repodata
            createrepo_c repo/rpm/$EL_VERSION/x86_64/
            createrepo_c repo/rpm/$EL_VERSION/aarch64/

            # Sign repodata
            gpg --batch --yes --armor --detach-sign \
              --output repo/rpm/$EL_VERSION/x86_64/repodata/repomd.xml.asc \
              repo/rpm/$EL_VERSION/x86_64/repodata/repomd.xml
            gpg --batch --yes --armor --detach-sign \
              --output repo/rpm/$EL_VERSION/aarch64/repodata/repomd.xml.asc \
              repo/rpm/$EL_VERSION/aarch64/repodata/repomd.xml
          done

          echo "=== RPM repo structure ==="
          find repo/rpm -type f | head -30

      - name: Create repo config files
        run: |
          # Create YUM/DNF repo config
          cat > repo/rpm/xtom.repo << 'EOF'
          [xtom]
          name=xTom Repository
          baseurl=https://repo.xtom.com/rpm/el$releasever/$basearch/
          gpgcheck=1
          gpgkey=https://repo.xtom.com/xtom.key
          enabled=1
          EOF

          # Create README/instructions
          cat > repo/README.md << 'EOF'
          # xTom Package Repository

          ## Debian / Ubuntu

          ```bash
          curl -fsSL https://repo.xtom.com/xtom.key | sudo gpg --dearmor -o /usr/share/keyrings/xtom.gpg
          echo "deb [signed-by=/usr/share/keyrings/xtom.gpg] https://repo.xtom.com/deb stable main" | sudo tee /etc/apt/sources.list.d/xtom.list
          sudo apt update
          sudo apt install rdap
          ```

          ## RHEL / CentOS / Rocky / Alma

          ```bash
          sudo curl -o /etc/yum.repos.d/xtom.repo https://repo.xtom.com/rpm/xtom.repo
          sudo dnf install rdap
          ```
          EOF

      - name: Show final structure
        run: |
          echo "=== Final repository structure ==="
          find repo -type f

      - name: Deploy to repository server
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_HOST: rsync.repo.xtom.com
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          SOURCE: "repo/"
          TARGET: ${{ env.REPO_PATH }}/
          ARGS: "-avz"
